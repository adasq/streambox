<html>

<body>
<a href="/auth/google">sssssssssss</a>
<a href="/logout"> out</a>
czesc!

<link rel="stylesheet" href="bower_components/plyr/dist/plyr.css">
<script src="bower_components/plyr/dist/plyr.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

 
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<div><h3>czesc</h3></div> 

<!-- <video width="400" controls>
  <source src="/file?p=/nuta/09.2014/15.%20Slasher.mp3" type="audio/mp3">
  Your browser does not support HTML5 video.
</video> -->

<div style="bottom: 0px; position: fixed; width: 100%;" class="player">
    <audio controls>
        <!-- Audio files -->
        <source src="" type="audio/mp3"> 

        <!-- Fallback for browsers that don't support the <audio> element -->
        <a href="/file?p=/nuta/09.2014/15.%20Slasher.mp3">Download</a>
    </audio>
</div>

<ul id="list" style="margin-bottom: 100px;"></ul>
<script>

  



$(function(){

plyr.setup();
var player = document.querySelectorAll(".player")[0].plyr;
var media = player.media;


var playlist = {
	list: [],
	currentIndex: 0,
	play: function(index){	
		if( !_.isUndefined(index) )	{
			this.currentIndex = index;
		}
		player.source('/stream?mid='+encodeURIComponent(this.list[this.currentIndex].id));
		player.play();
	},
	setNext: function(){
		var nextIndex = this.currentIndex+1;
		if(this.list.length === nextIndex){
			this.currentIndex = 0;
		}else{
			this.currentIndex = nextIndex;
		}
		this.play();
	}
};




// media.addEventListener("playing", function() { 
//   console.log("playing");

// });

media.addEventListener("pause", function() { 
  console.log("pause", media.currentTime, media.duration);
  if(media.currentTime == media.duration){
  		playlist.setNext();
  }
});

$.get('/list', function(responseObj){
	console.log(responseObj);
	var array = [];
	_.each(responseObj, function(list){
		array = array.concat(list)
	});	
	playlist.list = array;
	init();

	var itemEl = $('<li></li>');
	var listEl = $('#list').on('click', 'li', function(event){
		var id = +event.target.id.split('-')[1];
	
		playlist.play(id);
	});
	_.each(array, function(item, i){
		listEl.append(itemEl.clone().text(item.name).attr('id', 'track-'+i));	
	});
	
 });

$.get('/au', function(responseObj){
	console.log(responseObj);
	 
 });



function init(){
	playlist.play();
}


});



</script>

</body>
<script>
(function(d, p){
    var a = new XMLHttpRequest(),
        b = d.body;
    a.open("GET", p, true);
    a.send();
    a.onload = function(){
        var c = d.createElement("div");
        c.style.display = "none";
        c.innerHTML = a.responseText;
        b.insertBefore(c, b.childNodes[0]);
    }
})(document, "bower_components/plyr/dist/sprite.svg");
</script>
</html>