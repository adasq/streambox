<html>
<head>
<script src="bower_components/plyr/dist/plyr.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<link rel="stylesheet" href="bower_components/plyr/dist/plyr.css">
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<style type="text/css">
	* {
		padding: 0;
		margin: 0;
	}
	body {
		padding: 15px;
		font-family: Arial;
	}
	#list{
		list-style: none;
		padding-left: 0;
	}
	#list li {
		margin-top: 3px;
		font-size: 11px;
		padding: 3px;
		background-color: rgba(0, 0, 0, 0.06);
		cursor: pointer;
	}
</style>
</head>
<body>
<!-- <a href="/auth/google">sssssssssss</a>
<a href="/logout"> out</a> -->

<div style="bottom: 0px; position: fixed; width: 100%;" class="player">
    <audio controls>
        <!-- Audio files -->
        <source src="" type="audio/mp3">  
    </audio>
</div>

<ul id="list" style="margin-bottom: 100px;"></ul>

</body>
<script>
$(function(){
plyr.setup();
var player = document.querySelectorAll(".player")[0].plyr;
var media = player.media;


var playlist = {
	list: [],
	currentIndex: 0,
	play: function(index){	
		if( !_.isUndefined(index) )	{
			this.currentIndex = index;
		}
		player.source('/stream?mid='+encodeURIComponent(this.list[this.currentIndex].id));
		player.play();
	},
	setNext: function(){
		var nextIndex = this.currentIndex+1;
		if(this.list.length === nextIndex){
			this.currentIndex = 0;
		}else{
			this.currentIndex = nextIndex;
		}
		this.play();
	}
};

media.addEventListener("pause", function() { 
  console.log("pause", media.currentTime, media.duration);
  if(media.currentTime == media.duration){
  		playlist.setNext();
  }
});

$.get('/list', function(responseObj){
	console.log(responseObj);
	var array = [];
	_.each(responseObj, function(list){
		array = array.concat(list)
	});	
	playlist.list = array;
	init();

	var itemEl = $('<li></li>');
	var listEl = $('#list').on('click', 'li', function(event){
		var id = +event.target.id.split('-')[1];
	
		playlist.play(id);
	});
	_.each(array, function(item, i){
		listEl.append(itemEl.clone().text(item.name).attr('id', 'track-'+i));	
	});
	
 });


function init(){
	playlist.play();
}
});
</script>
<script>
(function(d, p){
    var a = new XMLHttpRequest(),
        b = d.body;
    a.open("GET", p, true);
    a.send();
    a.onload = function(){
        var c = d.createElement("div");
        c.style.display = "none";
        c.innerHTML = a.responseText;
        b.insertBefore(c, b.childNodes[0]);
    }
})(document, "bower_components/plyr/dist/sprite.svg");
</script>
</html>